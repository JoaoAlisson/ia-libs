<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRE Gerencial — PluralMed</title>
    <meta name="description" content="Demonstrativo de Resultado do Exercício - PluralMed">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d27;
            --bg-card: #1e2130;
            --bg-hover: #252839;
            --bg-section: #1c2036;
            --bg-payment: #161828;
            --border: #2a2e42;
            --text-primary: #e8eaf0;
            --text-secondary: #8b90a5;
            --text-muted: #5c6078;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --green: #22c55e;
            --green-bg: rgba(34, 197, 94, 0.08);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.08);
            --gold: #f59e0b;
            --cyan: #06b6d4;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .control-group label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        input, select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input[type="text"] { width: 280px; }
        input[type="password"] { width: 200px; }
        input[type="month"] { width: 160px; }
        select { min-width: 180px; max-width: 260px; }

        /* Multi-select dropdown */
        .multi-select {
            position: relative;
            min-width: 200px;
        }
        .multi-select-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 32px 8px 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: border-color 0.2s;
            position: relative;
        }
        .multi-select-btn::after {
            content: '▾';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: var(--text-muted);
            pointer-events: none;
        }
        .multi-select-btn:hover, .multi-select-btn.open {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            min-width: 240px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 100;
            max-height: 280px;
            overflow-y: auto;
        }
        .multi-select-dropdown.open { display: block; }
        .multi-select-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: none;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            outline: none;
            border-radius: 8px 8px 0 0;
        }
        .multi-select-actions {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }
        .multi-select-actions button {
            flex: 1;
            background: none;
            border: none;
            color: var(--accent);
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 600;
            padding: 6px 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .multi-select-actions button:hover { background: var(--accent-glow); }
        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 12px;
            cursor: pointer;
            transition: background 0.1s;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .multi-select-item:hover { background: var(--bg-hover); }
        .multi-select-item.hidden { display: none; }
        .multi-select-item input[type="checkbox"] {
            accent-color: var(--accent);
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        .multi-select-count {
            display: inline-block;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #818cf8);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* Summary bar */
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px 32px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }

        .summary-card.receita::before { background: linear-gradient(90deg, var(--green), #4ade80); }
        .summary-card.margem::before { background: linear-gradient(90deg, var(--accent), #818cf8); }
        .summary-card.ebtida::before { background: linear-gradient(90deg, var(--cyan), #22d3ee); }
        .summary-card.lucro::before { background: linear-gradient(90deg, var(--gold), #fbbf24); }

        .summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .summary-value {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .summary-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Table */
        .table-container {
            padding: 0 32px 32px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
            font-size: 13px;
        }

        thead { position: sticky; top: 0; z-index: 10; }

        th {
            background: var(--bg-section);
            padding: 12px 14px;
            text-align: right;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }
        th:first-child, th:nth-child(2) { text-align: left; }

        td {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(42, 46, 66, 0.5);
            text-align: right;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }
        td:first-child { text-align: center; width: 32px; }
        td:nth-child(2) { text-align: left; }

        /* Section row (S) */
        tr.section-row {
            background: var(--bg-section);
            cursor: pointer;
            transition: background 0.15s;
        }
        tr.section-row:hover { background: var(--bg-hover); }
        tr.section-row td {
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            padding: 12px 14px;
        }
        tr.section-row td:first-child { color: var(--accent); font-size: 14px; }

        /* Detail row (N) */
        tr.detail-row { transition: background 0.1s; cursor: pointer; }
        tr.detail-row:hover { background: var(--bg-hover); }
        tr.detail-row td { color: var(--text-secondary); font-weight: 400; }
        tr.detail-row td:nth-child(2) { padding-left: 32px; font-size: 12px; }
        tr.detail-row.hidden { display: none; }

        /* Payment row */
        tr.payment-row { background: var(--bg-payment); }
        tr.payment-row.hidden { display: none; }
        tr.payment-row td {
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 300;
            border-bottom: 1px solid rgba(42, 46, 66, 0.3);
            padding: 6px 14px;
        }
        tr.payment-row td:nth-child(2) {
            padding-left: 52px;
            font-style: italic;
        }

        /* Calculated rows */
        tr.calculated-row {
            background: linear-gradient(90deg, rgba(99,102,241,0.06), transparent);
        }
        tr.calculated-row td {
            font-weight: 700;
            color: var(--accent);
            border-top: 2px solid var(--border);
            border-bottom: 2px solid var(--border);
        }

        .negative { color: var(--red) !important; }
        .positive { color: var(--green) !important; }
        .indicator { color: var(--text-muted) !important; font-size: 11px !important; font-weight: 400 !important; }

        .toggle-icon {
            display: inline-block;
            transition: transform 0.2s;
            font-size: 10px;
            margin-right: 4px;
        }
        .toggle-icon.collapsed { transform: rotate(-90deg); }

        /* Payment badge */
        .pag-badge {
            display: inline-block;
            background: var(--accent-glow);
            color: var(--accent);
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* Loading & status */
        .loading { text-align: center; padding: 60px; color: var(--text-muted); }

        .spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-msg {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 16px 32px;
            font-size: 13px;
            display: none;
        }
        .status-msg.error {
            background: var(--red-bg); border: 1px solid rgba(239,68,68,0.3); color: var(--red); display: block;
        }
        .status-msg.info {
            background: var(--accent-glow); border: 1px solid rgba(99,102,241,0.3); color: #818cf8; display: block;
        }

        .empty-state {
            text-align: center;
            padding: 80px 32px;
            color: var(--text-muted);
        }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }

        @media (max-width: 768px) {
            .header { padding: 16px; }
            .summary-bar { padding: 16px; }
            .table-container { padding: 0 16px 16px; }
            input[type="text"] { width: 200px; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-top: 16px;
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div>
            <h1>DRE Gerencial</h1>
            <div class="header-subtitle">Demonstrativo de Resultado do Exercício — PluralMed</div>
        </div>
        <div class="controls">
            <div class="control-group">
                <label>API URL</label>
                <input type="text" id="apiUrl" value="https://api-dados.pluralmed.com.br" placeholder="http://localhost:8000">
            </div>
            <div class="control-group">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="X-API-Key">
            </div>
            <div class="control-group">
                <label>Competência</label>
                <input type="month" id="competencia" placeholder="Todos">
            </div>
            <div class="control-group">
                <label>Município</label>
                <div class="multi-select" id="msContainerMunicipio">
                    <button type="button" class="multi-select-btn" onclick="toggleMultiSelect('municipio')">Todos</button>
                    <div class="multi-select-dropdown" id="msDdMunicipio">
                        <input type="text" class="multi-select-search" placeholder="Buscar município..." oninput="filterMultiSelectItems('municipio', this.value)">
                        <div class="multi-select-actions">
                            <button type="button" onclick="msSelectAll('municipio')">Todos</button>
                            <button type="button" onclick="msClearAll('municipio')">Limpar</button>
                        </div>
                        <div class="multi-select-items" id="msItemsMunicipio"></div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <label>Empresa</label>
                <div class="multi-select" id="msContainerEmpresa">
                    <button type="button" class="multi-select-btn" onclick="toggleMultiSelect('empresa')">Todas</button>
                    <div class="multi-select-dropdown" id="msDdEmpresa">
                        <input type="text" class="multi-select-search" placeholder="Buscar empresa..." oninput="filterMultiSelectItems('empresa', this.value)">
                        <div class="multi-select-actions">
                            <button type="button" onclick="msSelectAll('empresa')">Todas</button>
                            <button type="button" onclick="msClearAll('empresa')">Limpar</button>
                        </div>
                        <div class="multi-select-items" id="msItemsEmpresa"></div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" id="btnLoad" onclick="loadDRE()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>
                    Carregar
                </button>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="btn btn-ghost" onclick="toggleAllSections()">▶ Expandir / Recolher</button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('gerencial')">DRE GERENCIAL (Orçado)</button>
        <button class="tab-btn" onclick="switchTab('consolidada')">DRE CONSOLIDADA (Realizado)</button>
    </div>

    <div id="statusMsg" class="status-msg"></div>

    <!-- Summary Cards -->
    <div class="summary-bar" id="summaryBar" style="display:none;">
        <div class="summary-card receita">
            <div class="summary-label">Receita Bruta</div>
            <div class="summary-value" id="sumReceita">—</div>
            <div class="summary-indicator" id="sumReceitaInd"></div>
        </div>
        <div class="summary-card margem">
            <div class="summary-label">Margem Bruta</div>
            <div class="summary-value" id="sumMargem">—</div>
            <div class="summary-indicator" id="sumMargemInd"></div>
        </div>
        <div class="summary-card ebtida">
            <div class="summary-label">EBTIDA</div>
            <div class="summary-value" id="sumEbtida">—</div>
            <div class="summary-indicator" id="sumEbtidaInd"></div>
        </div>
        <div class="summary-card lucro">
            <div class="summary-label">Lucro Líquido Final</div>
            <div class="summary-value" id="sumLucro">—</div>
            <div class="summary-indicator" id="sumLucroInd"></div>
        </div>
    </div>

    <!-- DRE Table -->
    <div class="table-container">
        <div id="content">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 10h18M3 14h18M3 18h18M3 6h18"/>
                </svg>
                <p>Configure a API e clique em <strong>Carregar</strong></p>
            </div>
        </div>
    </div>

    <script>
    // ======================================================================
    // State
    // ======================================================================
    let allExpanded = false;
    let dreData = [];
    let empresas = []; // Array of { id: 1, name: 'Empresa X' }
    let allEmpresas = []; // All companies (for filter dropdown)
    let allMunicipios = []; // All municipalities (for filter dropdown)
    let currentTab = 'gerencial'; // 'gerencial' | 'consolidada'

    // ======================================================================
    // Helpers
    // ======================================================================
    function fmtBRL(val) {
        if (val === null || val === undefined || isNaN(val)) return '—';
        return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtPct(val) {
        if (!val || isNaN(val)) return '';
        return (val * 100).toFixed(2) + '%';
    }

    function valClass(val) {
        if (val > 0.01) return 'positive';
        if (val < -0.01) return 'negative';
        return '';
    }

    /**
     * Normaliza o campo COMPETENCIA vindo da API para "YYYY-MM".
     * Formato real do Sankhya: "DDMMYYYY HH:MM:SS" (ex: "01122025 00:00:00" = dez/2025)
     * Também suporta: "2026-01", "2026-01-01", "2026-01-01T00:00:00"
     */
    function normalizeComp(val) {
        if (!val) return '';
        const s = String(val).trim();
        // Already YYYY-MM
        if (/^\d{4}-\d{2}$/.test(s)) return s;
        // Sankhya format: DDMMYYYY or DDMMYYYY HH:MM:SS
        const sankhya = s.match(/^(\d{2})(\d{2})(\d{4})/);
        if (sankhya) {
            const month = sankhya[2];
            const year = sankhya[3];
            return `${year}-${month}`;
        }
        // ISO date or datetime: YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS
        const iso = s.match(/^(\d{4})-(\d{2})/);
        if (iso) return `${iso[1]}-${iso[2]}`;
        // Timestamp (ms)
        if (/^\d{10,}$/.test(s)) {
            const d = new Date(parseInt(s));
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        }
        return s;
    }

    function showStatus(type, msg) {
        const el = document.getElementById('statusMsg');
        el.className = 'status-msg' + (type ? ' ' + type : '');
        el.textContent = msg;
    }

    const CALCULATED_TYPES = new Set([
        'RECEITA LÍQUIDA', 'MARGEM BRUTA', 'PLATAFORMA DE GESTÃO',
        'EBTIDA', 'LUCRO LÍQUIDO', 'LUCRO LÍQUIDO FINAL'
    ]);

    // Renomeia tipos vindos do backend para exibição
    // Cobre tanto nomes antigos (CSP -) quanto novos do gold.py
    const TIPO_DISPLAY = {
        'CSP - MERCADO EXTERNO': 'CUSTO DO SERVICO - MERCADO EXTERNO',
        'CSP - MEDICOS': 'CUSTO DO SERVIÇO - MEDICOS',
        'CSP - GASTO POR CONTRATOS': 'CUSTO DO SERVIÇO - GASTO POR CONTRATOS',
        'MARGEM BRUTA': 'MARGEM BRUTA (MARGEM DE CONTRIBUIÇÃO)',
    };

    // ======================================================================
    // Multi-select component
    // ======================================================================
    let msSelected = { empresa: new Set(), municipio: new Set() };

    function toggleMultiSelect(type) {
        const dd = document.getElementById(`msDd${capitalize(type)}`);
        const btn = dd.previousElementSibling;
        const wasOpen = dd.classList.contains('open');
        // Close all dropdowns first
        document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
        document.querySelectorAll('.multi-select-btn').forEach(b => b.classList.remove('open'));
        if (!wasOpen) {
            dd.classList.add('open');
            btn.classList.add('open');
            const search = dd.querySelector('.multi-select-search');
            if (search) { search.value = ''; filterMultiSelectItems(type, ''); search.focus(); }
        }
    }

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function filterMultiSelectItems(type, query) {
        const q = query.toLowerCase();
        const items = document.querySelectorAll(`#msItems${capitalize(type)} .multi-select-item`);
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.classList.toggle('hidden', q && !text.includes(q));
        });
    }

    function msSelectAll(type) {
        const checkboxes = document.querySelectorAll(`#msItems${capitalize(type)} input[type="checkbox"]`);
        checkboxes.forEach(cb => {
            if (!cb.closest('.multi-select-item').classList.contains('hidden')) {
                cb.checked = true;
                msSelected[type].add(cb.value);
            }
        });
        onMultiSelectChange(type);
    }

    function msClearAll(type) {
        const checkboxes = document.querySelectorAll(`#msItems${capitalize(type)} input[type="checkbox"]`);
        checkboxes.forEach(cb => { cb.checked = false; });
        msSelected[type].clear();
        onMultiSelectChange(type);
    }

    function onMultiSelectToggle(type, value, checked) {
        if (checked) msSelected[type].add(value);
        else msSelected[type].delete(value);
        onMultiSelectChange(type);
    }

    function onMultiSelectChange(type) {
        updateMultiSelectLabel(type);
        if (type === 'municipio') refreshEmpresaItems();
        applyFilters();
    }

    function updateMultiSelectLabel(type) {
        const btn = document.querySelector(`#msContainer${capitalize(type)} .multi-select-btn`);
        const count = msSelected[type].size;
        const allLabel = type === 'empresa' ? 'Todas' : 'Todos';
        if (count === 0) {
            btn.innerHTML = allLabel;
        } else {
            const totalItems = document.querySelectorAll(`#msItems${capitalize(type)} .multi-select-item`).length;
            if (count === totalItems) {
                btn.innerHTML = allLabel;
            } else if (count <= 2) {
                const names = [];
                msSelected[type].forEach(v => {
                    const item = document.querySelector(`#msItems${capitalize(type)} input[value="${CSS.escape(v)}"]`);
                    if (item) names.push(item.parentElement.querySelector('span').textContent);
                });
                btn.innerHTML = names.join(', ');
            } else {
                btn.innerHTML = `${count} selecionado${count > 1 ? 's' : ''} <span class="multi-select-count">${count}</span>`;
            }
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.multi-select')) {
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.multi-select-btn').forEach(b => b.classList.remove('open'));
        }
    });

    // ======================================================================
    // Filters (Empresa & Município)
    // ======================================================================

    function populateFilters() {
        // 1) Build empresa map from dreData
        const empMap = new Map();
        dreData.forEach(r => {
            const id = String(r.CODEMP);
            if (!empMap.has(id)) {
                empMap.set(id, {
                    id: id,
                    name: r.NOMEFANTASIA || `EMP ${r.CODEMP}`,
                    municipios: new Set()
                });
            }
        });

        // 2) Extract municípios from subtipo of RECEITA BRUTA detail rows
        dreData.forEach(r => {
            if (r.tipo === 'RECEITA BRUTA' && r.agrupador === 'N' && r.subtipo) {
                const mun = String(r.subtipo).trim();
                if (mun) {
                    const id = String(r.CODEMP);
                    const emp = empMap.get(id);
                    if (emp) emp.municipios.add(mun);
                }
            }
        });

        // Convert Sets to arrays
        allEmpresas = Array.from(empMap.values())
            .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
        allEmpresas.forEach(e => e.municipios = [...e.municipios].sort());

        // 3) Compute unique municípios
        const munSet = new Set();
        allEmpresas.forEach(e => e.municipios.forEach(m => munSet.add(m)));
        allMunicipios = [...munSet].sort((a, b) => a.localeCompare(b, 'pt-BR'));

        // 4) Populate município multi-select
        const munContainer = document.getElementById('msItemsMunicipio');
        munContainer.innerHTML = '';
        allMunicipios.forEach(m => {
            const safeVal = m.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            munContainer.innerHTML += `<label class="multi-select-item" data-value="${safeVal}">
                <input type="checkbox" value="${safeVal}" onchange="onMultiSelectToggle('municipio',this.value,this.checked)">
                <span>${m}</span>
            </label>`;
        });
        msSelected.municipio.clear();
        updateMultiSelectLabel('municipio');

        // 5) Populate empresa multi-select
        msSelected.empresa.clear();
        refreshEmpresaItems();
    }

    function refreshEmpresaItems() {
        const selectedMunicipios = msSelected.municipio;
        let visibleEmpresas = allEmpresas;
        if (selectedMunicipios.size > 0) {
            // Show empresas that have at least one matching municipio
            visibleEmpresas = allEmpresas.filter(e =>
                e.municipios.some(m => selectedMunicipios.has(m))
            );
        }

        const empContainer = document.getElementById('msItemsEmpresa');
        empContainer.innerHTML = '';
        visibleEmpresas.forEach(emp => {
            const checked = msSelected.empresa.has(emp.id) ? ' checked' : '';
            empContainer.innerHTML += `<label class="multi-select-item" data-value="${emp.id}">
                <input type="checkbox" value="${emp.id}"${checked} onchange="onMultiSelectToggle('empresa',this.value,this.checked)">
                <span>${emp.name}</span>
            </label>`;
        });

        // Remove empresas from selection that are no longer visible
        const visibleIds = new Set(visibleEmpresas.map(e => e.id));
        [...msSelected.empresa].forEach(id => {
            if (!visibleIds.has(id)) msSelected.empresa.delete(id);
        });
        updateMultiSelectLabel('empresa');
    }

    function getFilteredData() {
        let data = dreData;
        const selectedMunicipios = msSelected.municipio;
        const selectedEmpresas = msSelected.empresa;

        if (selectedMunicipios.size > 0) {
            // 1. Restrict to CODEMPs of empresas that operate in selected municípios
            const codEmps = new Set(
                allEmpresas
                    .filter(e => e.municipios.some(m => selectedMunicipios.has(m)))
                    .map(e => e.id)
            );
            data = data.filter(r => codEmps.has(String(r.CODEMP)));

            // 2. Among detail rows (N), hide municipality rows that aren't selected
            const allMunSet = new Set(allMunicipios);
            data = data.filter(r => {
                if (r.agrupador !== 'N') return true; // section rows always pass
                const sub = String(r.subtipo || '').trim();
                if (allMunSet.has(sub)) {
                    // This detail row IS a municipality row — keep only if selected
                    return selectedMunicipios.has(sub);
                }
                return true; // non-municipality detail rows pass through
            });
        }
        if (selectedEmpresas.size > 0) {
            data = data.filter(r => selectedEmpresas.has(String(r.CODEMP)));
        }
        return data;
    }

    function applyFilters() {
        if (!dreData.length) return;

        // Re-derive empresas (table columns) from filtered data
        const filtered = getFilteredData();
        const empMap = new Map();
        filtered.forEach(r => {
            const id = String(r.CODEMP);
            if (!empMap.has(id)) {
                empMap.set(id, r.NOMEFANTASIA || `EMP ${r.CODEMP}`);
            }
        });
        empresas = Array.from(empMap.entries())
            .map(([id, name]) => ({ id, name }))
            .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));

        renderSummary();
        renderTable();
    }

    // ======================================================================
    // Tabs
    // ======================================================================
    function switchTab(tab) {
        currentTab = tab;
        // Update styling
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(tab)) btn.classList.add('active');
        });
        // Re-render
        if (dreData.length) {
            renderSummary();
            renderTable();
        }
    }

    // ======================================================================
    // Load data from API
    // ======================================================================
    async function loadDRE() {
        const url = document.getElementById('apiUrl').value.replace(/\/+$/, '');
        const key = document.getElementById('apiKey').value;
        const compInput = document.getElementById('competencia').value; // "YYYY-MM" from month input

        const btn = document.getElementById('btnLoad');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;margin:0;border-width:2px"></div> Carregando...';
        showStatus('', '');

        try {
            // Fetch ALL data and filter client-side for robustness
            const resp = await fetch(`${url}/sankhya/dre/v1/gold`, {
                headers: { 'X-API-Key': key }
            });

            if (!resp.ok) {
                const err = await resp.json().catch(() => ({}));
                throw new Error(err.detail || `HTTP ${resp.status}`);
            }

            dreData = await resp.json();

            if (!dreData.length) {
                showStatus('info', 'Nenhum dado retornado. Verifique se o pipeline DRE foi executado no Dagster.');
                document.getElementById('content').innerHTML = '';
                document.getElementById('summaryBar').style.display = 'none';
                return;
            }

            // Normalize COMPETENCIA in all records
            dreData.forEach(r => {
                r._comp = normalizeComp(r.COMPETENCIA);
                if (r.pagamentos) {
                    r.pagamentos.forEach(p => { p._comp = normalizeComp(p.COMPETENCIA); });
                }
            });

            // Client-side filter by competencia
            if (compInput) {
                const filtered = dreData.filter(r => r._comp === compInput);
                if (!filtered.length) {
                    const normComps = [...new Set(dreData.map(r => r._comp))];
                    showStatus('info',
                        `Nenhum dado para competência "${compInput}". ` +
                        `Competências disponíveis: ${normComps.sort().join(', ')}`
                    );
                    document.getElementById('content').innerHTML = '';
                    document.getElementById('summaryBar').style.display = 'none';
                    return;
                }
                dreData = filtered;
            }

            // Discover companies with names
            const empMap = new Map();
            dreData.forEach(r => {
                if (!empMap.has(r.CODEMP)) {
                    empMap.set(r.CODEMP, r.NOMEFANTASIA || `EMP ${r.CODEMP}`);
                }
            });
            empresas = Array.from(empMap.entries())
                .map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.id - b.id);

            populateFilters();
            applyFilters();

        } catch (e) {
            showStatus('error', `Erro: ${e.message}`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Carregar';
        }
    }

    // ======================================================================
    // Summary cards
    // ======================================================================
    function renderSummary() {
        const filtered = getFilteredData();
        const summaries = filtered.filter(r => r.agrupador === 'S');
        const valProp = currentTab === 'gerencial' ? 'valor_previsto' : 'valor_realizado';

        const get = (tipo) => {
            const rows = summaries.filter(r => r.tipo === tipo);
            return rows.reduce((acc, r) => acc + (r[valProp] || 0), 0);
        };

        const receita = get('RECEITA BRUTA');
        const margem = get('MARGEM BRUTA');
        const ebtida = get('EBTIDA');
        const lucro = get('LUCRO LÍQUIDO FINAL');

        document.getElementById('sumReceita').textContent = fmtBRL(receita);
        document.getElementById('sumMargem').textContent = fmtBRL(margem);
        document.getElementById('sumEbtida').textContent = fmtBRL(ebtida);
        document.getElementById('sumLucro').textContent = fmtBRL(lucro);

        const pct = (v) => receita ? `${((v/receita)*100).toFixed(1)}% da receita` : '';
        document.getElementById('sumReceitaInd').textContent = '';
        document.getElementById('sumMargemInd').textContent = pct(margem);
        document.getElementById('sumEbtidaInd').textContent = pct(ebtida);
        document.getElementById('sumLucroInd').textContent = pct(lucro);

        document.getElementById('summaryBar').style.display = 'grid';
    }

    // ======================================================================
    // Table rendering
    // ======================================================================
    function renderTable() {
        const valProp = currentTab === 'gerencial' ? 'valor_previsto' : 'valor_realizado';

        // Pivot: key → { empresas: { empId: val }, pagamentos: [...] }
        const pivot = {};

        const filtered = getFilteredData();
        filtered.forEach(row => {
            const key = `${row.ordem}|${row.agrupador}|${row.tipo}|${row.subtipo}`;
            if (!pivot[key]) {
                pivot[key] = {
                    ordem: row.ordem,
                    agrupador: row.agrupador,
                    tipo: row.tipo,
                    subtipo: row.subtipo,
                    indicador: row.indicador || 0,
                    empresas: {},
                    total: 0,
                    pagamentos: [],
                };
            }
            const val = row[valProp] || 0;
            const empKey = String(row.CODEMP);
            pivot[key].empresas[empKey] = (pivot[key].empresas[empKey] || 0) + val;
            pivot[key].total += val;

            if (row.pagamentos && row.pagamentos.length) {
                pivot[key].pagamentos.push(...row.pagamentos);
            }
        });

        // Sort
        const rows = Object.values(pivot).sort((a, b) => {
            if (a.ordem !== b.ordem) return a.ordem - b.ordem;
            if (a.agrupador !== b.agrupador) return a.agrupador === 'S' ? -1 : 1;
            return (a.subtipo || '').localeCompare(b.subtipo || '', 'pt-BR');
        });

        // Determine if usage logic is monthly (default) - used for ANO projection
        // If total is X, ANO (Proj.) = X * 12.
        // But if filtering multiple months, this logic changes. Assuming single month filter for now.
        const isSingleMonth = !!document.getElementById('competencia').value;

        // Build HTML
        let html = '<table><thead><tr>';
        html += '<th></th><th>DRE</th><th>%</th><th>MÊS</th>';
        if (isSingleMonth) html += '<th>ANO (Proj.)</th>';
        empresas.forEach(emp => { html += `<th>${emp.name}</th>`; });
        html += '</tr></thead><tbody>';

        // --- Generate Receita Líquida detail rows (Receita Bruta - Imposto per subtipo) ---
        const recBrutaDetails = {}; // subtipo -> { empresas: {empId: val}, total }
        const impostoDetails = {};
        const cspDetails = {};  // subtipo -> { empresas: {empId: val}, total }
        const CSP_TIPOS = new Set([
            'CUSTO DO SERVICO - MERCADO EXTERNO',
            'CUSTO DO SERVIÇO - MEDICOS',
            'CUSTO DO SERVIÇO - GASTO POR CONTRATOS',
            'CSP - MERCADO EXTERNO',
            'CSP - MEDICOS',
            'CSP - GASTO POR CONTRATOS',
        ]);
        rows.forEach(row => {
            if (row.agrupador !== 'N') return;
            let target = null;
            if (row.tipo === 'RECEITA BRUTA') target = recBrutaDetails;
            else if (row.tipo === 'IMPOSTO') target = impostoDetails;
            else if (CSP_TIPOS.has(row.tipo)) target = cspDetails;
            if (!target) return;
            const sub = row.subtipo || '';
            if (!target[sub]) target[sub] = { empresas: {}, total: 0 };
            target[sub].total += row.total;
            for (const [empId, val] of Object.entries(row.empresas)) {
                target[sub].empresas[empId] = (target[sub].empresas[empId] || 0) + val;
            }
        });
        // Build synthetic Receita Líquida detail rows
        const allSubtipos = new Set([...Object.keys(recBrutaDetails), ...Object.keys(impostoDetails)]);
        allSubtipos.forEach(sub => {
            const rb = recBrutaDetails[sub] || { empresas: {}, total: 0 };
            const imp = impostoDetails[sub] || { empresas: {}, total: 0 };
            const empresasRL = {};
            const allEmpIds = new Set([...Object.keys(rb.empresas), ...Object.keys(imp.empresas)]);
            allEmpIds.forEach(empId => {
                empresasRL[empId] = (rb.empresas[empId] || 0) - (imp.empresas[empId] || 0);
            });
            rows.push({
                ordem: 300,
                agrupador: 'N',
                tipo: 'RECEITA LÍQUIDA',
                subtipo: sub,
                indicador: 0,
                empresas: empresasRL,
                total: rb.total - imp.total,
                pagamentos: [],
            });
        });

        // --- Generate MARGEM BRUTA detail rows (Receita Líquida - CSP per subtipo) ---
        // Receita Líquida per subtipo = recBruta - imposto (already computed above)
        const rlDetails = {};
        allSubtipos.forEach(sub => {
            const rb = recBrutaDetails[sub] || { empresas: {}, total: 0 };
            const imp = impostoDetails[sub] || { empresas: {}, total: 0 };
            rlDetails[sub] = { empresas: {}, total: rb.total - imp.total };
            const empIds = new Set([...Object.keys(rb.empresas), ...Object.keys(imp.empresas)]);
            empIds.forEach(empId => {
                rlDetails[sub].empresas[empId] = (rb.empresas[empId] || 0) - (imp.empresas[empId] || 0);
            });
        });
        const mbSubtipos = new Set([...Object.keys(rlDetails), ...Object.keys(cspDetails)]);
        mbSubtipos.forEach(sub => {
            const rl = rlDetails[sub] || { empresas: {}, total: 0 };
            const csp = cspDetails[sub] || { empresas: {}, total: 0 };
            const empresasMB = {};
            const empIds = new Set([...Object.keys(rl.empresas), ...Object.keys(csp.empresas)]);
            empIds.forEach(empId => {
                empresasMB[empId] = (rl.empresas[empId] || 0) - (csp.empresas[empId] || 0);
            });
            rows.push({
                ordem: 700,
                agrupador: 'N',
                tipo: 'MARGEM BRUTA',
                subtipo: sub,
                indicador: 0,
                empresas: empresasMB,
                total: rl.total - csp.total,
                pagamentos: [],
            });
        });

        // Re-sort after adding synthetic rows
        rows.sort((a, b) => {
            if (a.ordem !== b.ordem) return a.ordem - b.ordem;
            if (a.agrupador !== b.agrupador) return a.agrupador === 'S' ? -1 : 1;
            return (a.subtipo || '').localeCompare(b.subtipo || '', 'pt-BR');
        });

        let rowIdx = 0;
        rows.forEach(row => {
            const isSec = row.agrupador === 'S';
            const isCalc = CALCULATED_TYPES.has(row.tipo);
            const ordem = Number(row.ordem);
            const hasDetails = !isSec ? false : rows.some(r => Number(r.ordem) === ordem && r.agrupador === 'N');
            const hasPag = !isSec && row.pagamentos.length > 0;
            const rid = `row-${rowIdx}`;
            rowIdx++;

            // CSS classes
            let trClass = '';
            if (isSec && isCalc) trClass = 'section-row calculated-row';
            else if (isSec) trClass = 'section-row';
            else trClass = 'detail-row hidden';

            const onclick = isSec
                ? `onclick="toggleSection(${ordem})"`
                : (hasPag ? `onclick="togglePayments('${rid}')"` : '');

            const dataSec = !isSec ? `data-section="${ordem}"` : '';

            html += `<tr class="${trClass}" ${onclick} ${dataSec} id="${isSec ? 'sec-' + ordem : rid}">`;

            // Col: toggle icon
            if (isSec && hasDetails) {
                html += '<td><span class="toggle-icon collapsed">▶</span></td>';
            } else if (!isSec && hasPag) {
                html += `<td><span class="toggle-icon collapsed pag-toggle" data-target="${rid}">▶</span></td>`;
            } else {
                html += '<td></td>';
            }

            // Col: name
            const rawName = isSec ? row.tipo : row.subtipo;
            const name = TIPO_DISPLAY[rawName] || rawName;
            const badge = hasPag ? `<span class="pag-badge">${row.pagamentos.length} pag</span>` : '';
            html += `<td>${name}${badge}</td>`;

            // Col: indicator
            html += `<td class="indicator">${isSec ? fmtPct(row.indicador) : ''}</td>`;

            // Col: month total
            html += `<td class="${valClass(row.total)}">${fmtBRL(row.total)}</td>`;

            // Col: Year Projection
            if (isSingleMonth) {
                const proj = row.total * 12;
                html += `<td class="${valClass(proj)}">${fmtBRL(proj)}</td>`;
            }

            // Cols: per company
            empresas.forEach(emp => {
                const v = row.empresas[emp.id] || 0;
                html += `<td class="${valClass(v)}">${fmtBRL(v)}</td>`;
            });

            html += '</tr>';

            // Payment rows (hidden by default)
            if (hasPag) {
                row.pagamentos.forEach(pag => {
                    html += `<tr class="payment-row hidden" data-payments="${rid}">`;
                    html += '<td></td>';
                    const pagDesc = pag.DESCRNAT || pag.DESCRCENCUS || '—';
                    const pagNat = pag.CODNAT ? `[${pag.CODNAT}]` : '';
                    html += `<td>${pagNat} ${pagDesc}</td>`;

                    // Col: % (indicator) - empty
                    html += '<td class="indicator"></td>';

                    // Col: MÊS - valor do pagamento
                    const pagVal = valProp === 'valor_previsto' ? (pag.VLRDESDOB || 0) : (pag.VLRBAIXA || 0);
                    html += `<td class="${valClass(pagVal)}">${fmtBRL(pagVal)}</td>`;

                    // Col: ANO (Proj.)
                    if (isSingleMonth) html += '<td></td>';

                    // Cols: per company - mostra valor na coluna da empresa do pagamento
                    const pagEmpId = String(pag.CODEMP);
                    empresas.forEach(emp => {
                        if (emp.id === pagEmpId) {
                            html += `<td class="${valClass(pagVal)}">${fmtBRL(pagVal)}</td>`;
                        } else {
                            html += '<td></td>';
                        }
                    });
                    html += '</tr>';
                });
            }
        });

        html += '</tbody></table>';
        document.getElementById('content').innerHTML = html;
    }

    // ======================================================================
    // Toggle sections & payments
    // ======================================================================
    function toggleSection(ordem) {
        const details = document.querySelectorAll(`tr[data-section="${ordem}"]`);
        const icon = document.querySelector(`#sec-${ordem} .toggle-icon`);

        details.forEach(tr => {
            tr.classList.toggle('hidden');
            // When collapsing section, also collapse any open payments
            if (tr.classList.contains('hidden')) {
                const rid = tr.id;
                if (rid) {
                    const payRows = document.querySelectorAll(`tr[data-payments="${rid}"]`);
                    payRows.forEach(p => p.classList.add('hidden'));
                    const payIcon = tr.querySelector('.pag-toggle');
                    if (payIcon) payIcon.classList.add('collapsed');
                }
            }
        });
        if (icon) icon.classList.toggle('collapsed');
    }

    function togglePayments(rid) {
        const payRows = document.querySelectorAll(`tr[data-payments="${rid}"]`);
        const icon = document.querySelector(`#${rid} .pag-toggle`);
        payRows.forEach(p => p.classList.toggle('hidden'));
        if (icon) icon.classList.toggle('collapsed');
    }

    function toggleAllSections() {
        allExpanded = !allExpanded;
        const details = document.querySelectorAll('tr.detail-row');
        const icons = document.querySelectorAll('.toggle-icon');
        const payments = document.querySelectorAll('tr.payment-row');

        details.forEach(tr => {
            if (allExpanded) tr.classList.remove('hidden');
            else tr.classList.add('hidden');
        });
        // Collapse payments when toggling all
        payments.forEach(tr => tr.classList.add('hidden'));

        icons.forEach(icon => {
            if (allExpanded && !icon.classList.contains('pag-toggle')) icon.classList.remove('collapsed');
            else icon.classList.add('collapsed');
        });
    }

    // Enter to load
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT') loadDRE();
    });
    </script>
</body>
</html>
